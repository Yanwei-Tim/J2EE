Gala.Table=new Class({options:{headers:null,data:null,sortable:true,find_key:"id",query_url:null},initialize:function(_,A){this.element=$(_);this.setOptions(A);this.headers=[];this.rows=[];this.sortby=false;this.sortby2=false;this.sortasc=true;this._makeTable(this.element)},empty:function(){this.headers.each(function($){$.element.remove()},this);this.rows.each(function($){$.element.remove()},this);this.thead_tr.remove();this.tbody.remove()},_makeTable:function($){if(!$)return;if($.getTag()=="table"){this.element.addClass("gala_table").setProperty("cellspacing","1");this._makeTHead();this._build()}else return},_makeTHead:function(){if(this.element.getChildren().length>0)this.tbody=this.element.getChildren()[0];else this.tbody=new Element("tbody").injectInside(this.element);this.thead_tr=new Element("tr").injectInside(this.tbody)},_build:function(){if(this.options.headers&&$type(this.options.headers)=="array")this.options.headers.each(function($){switch($type($)){case"string":this._addHeader($.trim()==""?"&nbsp;":$);break;case"object":this._addHeader($.text||"&nbsp;",$);break;default:break}},this);this.options.headers=null;if(this.options.data&&$type(this.options.data)=="array")this._loadData(this.options.data)},_addHeader:function(A,$){var C=Object.extend({sortable:true,key:null,pkey:false},$||{}),_=new Element("td").setHTML(A).addClass("tHeader").injectInside(this.thead_tr);_.innerHTML=A;var B={element:_,value:A,options:C};B.element.col=this.headers.length;this.headers.push(B);if(B.options.hidden==true)B.element.setStyle("display","none");if(this.options.sortable&&B.options.sortable){B.element.addClass("sortable");B.element.addEvent("mouseup",function($){this.sort(B.element.col)}.pass(B.element,this))}},loadData:function(_,$){if(!$chk($))$=true;if(!$)this._emptyData();this._loadData(_)},getData:function(){var $=[];this.rows.each(function(A){var _;if($defined(A.data))$.push(A.data)});return $},_emptyData:function(){this.rows.each(function($){$.element.remove()});this.rows=[]},_loadData:function(A,_){if(!$chk(_))_=0;for(;_<A.length;_++){var $=A[_];if($type($)=="object")this.addRow($)}},addRow:function($){var _=this._createRow($);_.element.injectInside(this.tbody).addClass(this.rows.length%2==0?"trBg0":"trBg1");if($defined(this.options.query_url)){_.element.addEvent("click",function(){window.open(this.options.query_url+"?"+this.options.find_key+"="+$[this.options.find_key])}.bind(this));_.element.setStyle("cursor","hand")}_.data=$;this.rows.push(_)},_createRow:function($){var _={};_.element=new Element("tr");_.cols=[];switch($type($)){case"array":break;case"object":_.data=$;this.headers.each(function(C){var A=C.options.key?$[C.options.key]:"&nbsp;",B=this._createCell(A);B.element.injectInside(_.element);if(C.options.hidden==true)B.element.setStyle("display","none");_.cols.push(B)},this);break;default:break}return _},_createCell:function(_){var $={};if(!$defined(_))_="&nbsp;";$.value=_;$.element=new Element("td").setHTML(_);$.element.innerHTML=_;return $},sort:function($){if(this.rows.length==0)return;this.headers.each(function($){$.element.setProperty("width","");$.element.setStyle("width","auto")});if($chk(this.sortby))this.headers[this.sortby].element.removeClass("sorted_"+(this.sortasc?"asc":"desc"));if($chk(this.sortby)&&this.sortby==$)this.sortasc=!this.sortasc;else if($chk(this.sortby)){this.sortby2=this.sortby;this.sortasc=true}this.sortby=$;this.headers[this.sortby].element.addClass("sorted_"+(this.sortasc?"asc":"desc"));this.rows.sort(this.rowCompare.bind(this));this.rows.each(function($){$.element.remove()});var _=0;this.rows.each(function($){$.element.addClass(_%2==0?"trBg0":"trBg1");$.element.removeClass(_%2==0?"trBg1":"trBg0");$.element.injectInside(this.tbody);_++},this)},rowCompare:function($,_){a=$.cols[this.sortby].value;b=_.cols[this.sortby].value;if(a>b)return this.sortasc?1:-1;if(a<b)return this.sortasc?-1:1;if(this.sortby2){a=$.cols[this.sortby2].value;b=_.cols[this.sortby2].value;if(a>b)return this.sortasc?1:-1;if(a<b)return this.sortasc?-1:1}return 0},replaceRow:function(C,B,$){if(!C||!B||$type(B)!="object")return;var A=this._findRow(C);if($chk(A)){this.rows[A].data=B;var _=this.rows[A].cols;this.headers.each(function(C,A){var $=C.options.key?B[C.options.key]:"&nbsp;";if(!$defined($))$="&nbsp;";_[A].value=$;_[A].element.setHTML($);_[A].element.innerHTML=$},this)}else{if(!$chk($))$=true;if($)this.addRow(B)}},_findRow:function(_){for(var A=0;A<this.rows.length;A++){var $=this.rows[A].data;if($[this.options.find_key]==_)return A}},size:function(){return this.rows.length}});Gala.Table.implement(new Events,new Options)