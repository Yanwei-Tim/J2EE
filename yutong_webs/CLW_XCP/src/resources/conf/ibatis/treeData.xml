<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="TreeData">
	<typeAlias alias="Map" type="java.util.Map" />
	<typeAlias alias="String" type="java.lang.String" />
	<typeAlias alias="TreeNodeInfo" type="com.neusoft.clw.tree.domain.TreeNodeInfo" />
	<typeAlias alias="TreeNodesAttri" type="com.neusoft.clw.tree.domain.TreeNodesAttri" />
	
	<!-- 车辆监控-组织树 begin -->
	<resultMap class="TreeNodeInfo" id="treeNodes">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
    
	<select id="getTreeNodes" parameterClass="String" resultMap="treeNodes">
		SELECT * 
		  FROM (SELECT ENTERPRISE_ID as id,SHORT_NAME as name,PARENT_ID as pId,
						case when ENTERPRISE_ID=#enterpriseId# then 'true' else 'false' end open,
						'pIcon' as iconSkin,
						'' as dvrState
				  FROM CLW_JC_ENTERPRISE_T
			     START WITH ENTERPRISE_ID = #enterpriseId#
			   CONNECT BY PRIOR ENTERPRISE_ID = PARENT_ID
				   AND VALID_FLAG='0'
			     ORDER BY NLSSORT(name,'NLS_SORT=SCHINESE_PINYIN_M') DESC
			    )
	    UNION ALL
	    SELECT CAR_T.VEHICLE_VIN AS ID,
		       CAR_T.VEHICLE_LN AS NAME,
		       CAR_T.ORGANIZATION_ID AS PID,
		       'false' AS OPEN,
		       CASE
		         WHEN CAR_T.ONLINE_FLAG = '1' THEN
		          'online'
		         ELSE
		          'offline'
		       END AS iconSkin,
		       CASE
		         WHEN CAR_T.ONDVR_FLAG = '1' THEN
		          'ondvr'
		         ELSE
		          'offdvr'
		       END AS dvrState
		  FROM (SELECT CBI.VEHICLE_VIN,
		               CBI.VEHICLE_LN,
		               CBI.ORGANIZATION_ID,
		               CASE
		                 WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 30 * 60 THEN
		                  '0'
		                 WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 5 * 60 THEN
		                  '0'
		                  WHEN 
		                      JT.TERMINAL_TIME is null THEN
		                  '0'
		                 ELSE
		                  '1'
		               END ONLINE_FLAG,
		               CASE
		                 <!-- WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 30 * 60 THEN
		                  '0'
		                 WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 5 * 60 THEN
		                  '0'
		                  WHEN 
		                      JT.TERMINAL_TIME is null THEN
		                  '0'
		                  WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' THEN
		                  '0' -->
		                  WHEN 
		                      JT.TERMINAL_TIME is null THEN
		                  '0'
		                  WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 30 * 60 THEN
		                  '0'
		                  WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 5 * 60 THEN
		                  '0'
				  		  WHEN 
		                      NVL(SUBSTRB(JT.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
		                  '0'
		                  ELSE
		                  '1'
		               END ONDVR_FLAG
		          FROM CLW_JC_TERMINAL_T   JT,
		               CLW_CL_BASE_INFO_T  CBI,
		               CLW_CL_SIM_T        CS,
		               CLW_JC_ENTERPRISE_T JE
		         WHERE JT.VEHICLE_VIN = CBI.VEHICLE_VIN(+)
		           AND JT.SIM_CARD_NUMBER = CS.SIM_CARD_NUMBER(+)
		           AND CBI.ENTERPRISE_ID = JE.ENTERPRISE_ID(+)
		           AND JT.TERMINAL_ID IS NOT NULL
		           AND JT.VEHICLE_VIN IS NOT NULL
		           AND JT.SIM_CARD_NUMBER IS NOT NULL
		           AND JT.VALID_FLAG = '0'
		           AND CBI.VALID_FLAG = '0'
		           AND CS.VALID_FLAG = '0'
		           AND JT.DEVICE_TYPE = '0'
		           AND CBI.DEVICE_TYPE = '0'
		           AND CS.DEVICE_TYPE = '0'
		           AND CBI.ORGANIZATION_ID IS NOT NULL
                   AND EXISTS 
                   (SELECT 1
                          FROM CLW_JC_ENTERPRISE_VI
                         WHERE LEFT_NUM &gt;=
                               (SELECT LEFT_NUM
                                  FROM CLW_JC_ENTERPRISE_VI
                                 WHERE ENTERPRISE_ID =
                                       #enterpriseId#)
                           AND RIGHT_NUM &lt;=
                               (SELECT RIGHT_NUM
                                  FROM CLW_JC_ENTERPRISE_VI
                                 WHERE ENTERPRISE_ID =
                                       #enterpriseId#)
                           AND CBI.ORGANIZATION_ID = ENTERPRISE_ID)
		         ORDER BY ONLINE_FLAG DESC,NLSSORT(VEHICLE_LN,'NLS_SORT=SCHINESE_PINYIN_M') ASC) CAR_T
	</select>
	
	<resultMap class="TreeNodesAttri" id="carnumber_list">
       <result property="carnum" column="carnum"/>
       <result property="enterpriseId" column="enterprise_id"/>
    </resultMap>
	
	<select id="getCarnumberByEnterprise" parameterClass="String" resultMap="carnumber_list">
		SELECT parent_id as enterprise_id,
               CONCAT(CONCAT(SUM(ONNUM), '/'), SUM(CARNUM)) as carnum
          FROM (SELECT car_count_t.carnum,
                       connect_by_root(enterprise_id) parent_id,
                       ONNUM
                       <![CDATA[
                  FROM (SELECT T.enterprise_id,
                               0 AS CARNUM,
                               CASE
                                 WHEN T.ENTERPRISE_ID =
                                      #enterpriseId# THEN
                                  NULL
                                 ELSE
                                  T.parent_id
                               END AS parent_id,
                               0 AS ONNUM
                          FROM clw_jc_enterprise_t T
                         WHERE T.ENTERPRISE_ID IN
                               (select t.ENTERPRISE_ID
                                  from clw_jc_enterprise_t t
                                 where t.valid_flag = '0'
                                 START WITH t.ENTERPRISE_ID =
                                            #enterpriseId#
                                CONNECT BY PRIOR t.ENTERPRISE_ID = t.PARENT_ID)
                           AND ENTERPRISE_ID NOT IN
                               (select distinct cbi.organization_id
                                  FROM CLW_JC_TERMINAL_T   JT,
                                       CLW_CL_BASE_INFO_T  CBI,
                                       CLW_CL_SIM_T        CS,
                                       CLW_JC_ENTERPRISE_T JE
                                 WHERE JT.VEHICLE_VIN = CBI.VEHICLE_VIN(+)
                                   AND JT.SIM_CARD_NUMBER = CS.SIM_CARD_NUMBER(+)
                                   AND CBI.ENTERPRISE_ID = JE.ENTERPRISE_ID(+)
                                   AND JT.TERMINAL_ID IS NOT NULL
                                   AND JT.VEHICLE_VIN IS NOT NULL
                                   AND JT.SIM_CARD_NUMBER IS NOT NULL
                                   AND JT.VALID_FLAG = '0'
                                   AND CBI.VALID_FLAG = '0'
                                   AND CS.VALID_FLAG = '0'
                                   AND JT.DEVICE_TYPE = '0'
                                   AND CBI.DEVICE_TYPE = '0'
                                   AND CS.DEVICE_TYPE = '0'
                                   AND CBI.ORGANIZATION_ID IS NOT NULL
                                   AND CBI.ENTERPRISE_ID =
                                       #enterpriseId#)
                           and t.valid_flag = '0'
                        UNION ALL
                        SELECT CBI.ORGANIZATION_ID AS enterprise_id,
        			       COUNT(1) AS CARNUM,
        			       (select CASE
        			                 WHEN ENTERPRISE_ID = #enterpriseId# THEN
        			                  NULL
        			                 ELSE
        			                  parent_id
        			               END AS parent_id
        			          from clw_jc_enterprise_t
        			         where enterprise_id = CBI.ORGANIZATION_ID) as parent_id,
        			       SUM(CASE
        			             WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' AND
        			                 (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
        			              '0'
        			             WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '1' AND
        			                  (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
        			              '0'
        			             WHEN JT.TERMINAL_TIME is null THEN
        			              '0'
        			             ELSE
        			              '1'
        			           END) AS ONNUM
        			  FROM CLW_JC_TERMINAL_T   JT,
        			       CLW_CL_BASE_INFO_T  CBI,
        			       CLW_CL_SIM_T        CS,
        			       CLW_JC_ENTERPRISE_T JE
        			 WHERE JT.VEHICLE_VIN = CBI.VEHICLE_VIN(+)
        			   AND JT.SIM_CARD_NUMBER = CS.SIM_CARD_NUMBER(+)
        			   AND CBI.ENTERPRISE_ID = JE.ENTERPRISE_ID(+)
        			   AND JT.TERMINAL_ID IS NOT NULL
        			   AND JT.VEHICLE_VIN IS NOT NULL
        			   AND JT.SIM_CARD_NUMBER IS NOT NULL
        			   AND JT.VALID_FLAG = '0'
        			   AND CBI.VALID_FLAG = '0'
        			   AND CS.VALID_FLAG = '0'
        			   AND JT.DEVICE_TYPE = '0'
        			   AND CBI.DEVICE_TYPE = '0'
        			   AND CS.DEVICE_TYPE = '0'
        			   AND CBI.ORGANIZATION_ID IS NOT NULL
        			   AND EXISTS
        			 (SELECT 1
        			          FROM CLW_JC_ENTERPRISE_T
        			         WHERE VALID_FLAG = '0'
        			           AND LEFT_NUM >=
        			               (SELECT LEFT_NUM
        			                  FROM CLW_JC_ENTERPRISE_T
        			                 WHERE ENTERPRISE_ID = #enterpriseId#)
        			           AND RIGHT_NUM <=
        			               (SELECT RIGHT_NUM
        			                  FROM CLW_JC_ENTERPRISE_T
        			                 WHERE ENTERPRISE_ID = #enterpriseId#)
        			           AND CBI.ORGANIZATION_ID = ENTERPRISE_ID)
        			 GROUP BY CBI.ORGANIZATION_ID) car_count_t]]>
                CONNECT BY PRIOR car_count_t.enterprise_id = car_count_t.parent_id)
         GROUP BY parent_id

		
	</select>
	
	<resultMap class="TreeNodeInfo" id="searchTreeNodes">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
	
	<select id="searchTreeNodesByName" parameterClass="Map" resultMap="searchTreeNodes">
		SELECT * 
		  FROM (SELECT DISTINCT ENTERPRISE_ID as id,
				       SHORT_NAME as name,
				       PARENT_ID as pId,
				       case
				         when ENTERPRISE_ID=#enterpriseId# then
				          'true'
				         else
				          'true'
				       end open,
				       'pIcon' as iconSkin,
				       '' as dvrState
				  FROM CLW_JC_ENTERPRISE_T
				 WHERE LEFT_NUM &gt;=
				       (SELECT LEFT_NUM
				          FROM CLW_JC_ENTERPRISE_VI
				         WHERE ENTERPRISE_ID = #enterpriseId#)
				   AND RIGHT_NUM &lt;=
				       (SELECT RIGHT_NUM
				          FROM CLW_JC_ENTERPRISE_VI
				         WHERE ENTERPRISE_ID = #enterpriseId#)
				 START WITH ENTERPRISE_ID IN
				            (SELECT DISTINCT B.ORGANIZATION_ID ID
				               FROM CLW_JC_TERMINAL_T   T,
				                    CLW_CL_BASE_INFO_T  B,
				                    CLW_CL_SIM_T        S,
				                    CLW_JC_ENTERPRISE_T E
				              WHERE B.ORGANIZATION_ID IN
				                    (SELECT ENTERPRISE_ID
				                       FROM CLW_JC_ENTERPRISE_VI
				                      WHERE LEFT_NUM &gt;=
				                            (SELECT LEFT_NUM
				                               FROM CLW_JC_ENTERPRISE_VI
				                              WHERE ENTERPRISE_ID =
				                                    #enterpriseId#)
				                        AND RIGHT_NUM &lt;=
				                            (SELECT RIGHT_NUM
				                               FROM CLW_JC_ENTERPRISE_VI
				                              WHERE ENTERPRISE_ID =
				                                    #enterpriseId#))
				                AND B.VALID_FLAG = '0'
				                AND B.FEE_FLAG = '0'
				                AND S.VALID_FLAG = '0'
				                AND S.DEVICE_TYPE = '0'
				                AND T.VALID_FLAG = '0'
				                AND T.DEVICE_TYPE = '0'
				                AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
				                AND B.ORGANIZATION_ID = E.ENTERPRISE_ID(+)
				                AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
				                AND B.VEHICLE_LN like '%' || #name# ||'%' escape '\')
				CONNECT BY PRIOR PARENT_ID = ENTERPRISE_ID
				       AND VALID_FLAG = '0'
				  ORDER BY NLSSORT(name,'NLS_SORT=SCHINESE_PINYIN_M') DESC)     
		UNION ALL
		SELECT * 
		  FROM (SELECT DISTINCT T.VEHICLE_VIN ID,
		                B.VEHICLE_LN NAME,
		                B.ORGANIZATION_ID PID,
		                'false' AS OPEN,
		                CASE
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 30 * 60 THEN
		                   'offline'
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 5 * 60 THEN
		                   'offline'
		                   WHEN T.TERMINAL_TIME is null THEN
		                  			  'offline'
		                  ELSE
		                   'online'
		                END iconSkin,
		                CASE
		                 <!-- WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
		                  'offdvr'
		                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
		                  'offdvr'
		                  WHEN 
		                      T.TERMINAL_TIME is null THEN
		                  'offdvr'
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' THEN
		                  'offdvr' -->
		                  WHEN 
		                      T.TERMINAL_TIME is null THEN
		                  'offdvr'
		                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
		                  'offdvr'
		                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
		                  'offdvr'
				  		  WHEN 
		                      NVL(SUBSTRB(T.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
		                  'offdvr'
		                 ELSE
		                  'ondvr'
		               END dvrState
				  FROM CLW_JC_TERMINAL_T   T,
				       CLW_CL_BASE_INFO_T  B,
				       CLW_CL_SIM_T        S,
				       CLW_JC_ENTERPRISE_T E
				 WHERE ORGANIZATION_ID IN
				       (SELECT ENTERPRISE_ID
				          FROM CLW_JC_ENTERPRISE_VI
				         WHERE LEFT_NUM &gt;=
				               (SELECT LEFT_NUM
				                  FROM CLW_JC_ENTERPRISE_VI
				                 WHERE ENTERPRISE_ID = #enterpriseId#)
				           AND RIGHT_NUM &lt;=
				               (SELECT RIGHT_NUM
				                  FROM CLW_JC_ENTERPRISE_VI
				                 WHERE ENTERPRISE_ID = #enterpriseId#))
				   AND B.VALID_FLAG = '0'
				   AND B.FEE_FLAG = '0'
				   AND S.VALID_FLAG = '0'
				   AND S.DEVICE_TYPE = '0'
				   AND T.VALID_FLAG = '0'
				   AND T.DEVICE_TYPE = '0'
				   AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
				   AND B.ORGANIZATION_ID = E.ENTERPRISE_ID(+)
				   AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
				   AND B.VEHICLE_LN like '%' || #name# ||'%' escape '\'
			 ORDER BY iconskin DESC,NLSSORT(NAME,'NLS_SORT=SCHINESE_PINYIN_M') ASC)
	</select>
	
	<resultMap class="TreeNodeInfo" id="searchTreeNodesByDivision">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
    
	<select id="searchTreeNodesByDivisionName" parameterClass="Map" resultMap="searchTreeNodesByDivision">
		SELECT *
		  FROM (SELECT *
				  FROM (SELECT ENTERPRISE_ID as id,
						       SHORT_NAME as name,
						       PARENT_ID as pId,
						       'true' open,
						       'pIcon' iconSkin,
						       '' as dvrState
						  FROM CLW_JC_ENTERPRISE_T
						 WHERE VALID_FLAG = '0'
						   AND LEFT_NUM &gt;=
						       (SELECT LEFT_NUM
						          FROM CLW_JC_ENTERPRISE_VI
						         WHERE ENTERPRISE_ID = #enterpriseId#)
						   AND RIGHT_NUM &lt;=
						       (SELECT RIGHT_NUM
						          FROM CLW_JC_ENTERPRISE_VI
						         WHERE ENTERPRISE_ID = #enterpriseId#)
						 START WITH SHORT_NAME like '%' || #name# || '%' escape '\'
						CONNECT BY PRIOR PARENT_ID = ENTERPRISE_ID
						UNION
						SELECT ENTERPRISE_ID as id,
						       SHORT_NAME as name,
						       PARENT_ID as pId,
						       'true' open,
						       'pIcon' iconSkin,
						       '' as dvrState
						  FROM CLW_JC_ENTERPRISE_T
						 WHERE VALID_FLAG = '0'
						   AND LEFT_NUM &gt;=
						       (SELECT LEFT_NUM
						          FROM CLW_JC_ENTERPRISE_VI
						         WHERE ENTERPRISE_ID = #enterpriseId#)
						   AND RIGHT_NUM &lt;=
						       (SELECT RIGHT_NUM
						          FROM CLW_JC_ENTERPRISE_VI
						         WHERE ENTERPRISE_ID = #enterpriseId#)
						 START WITH SHORT_NAME like '%' || #name# || '%' escape '\'
						CONNECT BY PARENT_ID = PRIOR ENTERPRISE_ID)
					ORDER BY NLSSORT(name,'NLS_SORT=SCHINESE_PINYIN_M') DESC
				)
		UNION ALL
		SELECT *
		  FROM (SELECT DISTINCT T.VEHICLE_VIN ID,
		                B.VEHICLE_LN NAME,
		                B.ORGANIZATION_ID PID,
		                'false' AS OPEN,
		                CASE
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 30 * 60 THEN
		                   'offline'
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;= 5 * 60 THEN
		                   'offline'
		                   WHEN T.TERMINAL_TIME is null THEN
		                  			  'offline'
		                  ELSE
		                   'online'
		                END iconSkin,
		                CASE
		                 <!-- WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
		                  'offdvr'
		                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
		                  'offdvr'
		                  WHEN 
		                      T.TERMINAL_TIME is null THEN
		                  'offdvr' 
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' THEN
		                  'offdvr' -->
		                 WHEN 
		                      T.TERMINAL_TIME is null THEN
		                  'offdvr'
		                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
		                  'offdvr'
		                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
		                  'offdvr'
				  		  WHEN 
		                      NVL(SUBSTRB(T.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
		                  'offdvr'
		                 ELSE
		                  'ondvr'
		               END dvrState
				  FROM CLW_JC_TERMINAL_T   T,
				       CLW_CL_BASE_INFO_T  B,
				       CLW_CL_SIM_T        S,
				       CLW_JC_ENTERPRISE_T E
				 WHERE ORGANIZATION_ID IN
				       (SELECT ENTERPRISE_ID as id
				          FROM CLW_JC_ENTERPRISE_T
				         WHERE VALID_FLAG = '0'
				           AND ENTERPRISE_ID IN
				               (SELECT ENTERPRISE_ID
				                  FROM CLW_JC_ENTERPRISE_VI
				                 WHERE LEFT_NUM &gt;=
				                       (SELECT LEFT_NUM
				                          FROM CLW_JC_ENTERPRISE_VI
				                         WHERE ENTERPRISE_ID =
				                               #enterpriseId#)
				                   AND RIGHT_NUM &lt;=
				                       (SELECT RIGHT_NUM
				                          FROM CLW_JC_ENTERPRISE_VI
				                         WHERE ENTERPRISE_ID =
				                               #enterpriseId#))
				         START WITH SHORT_NAME like '%' || #name# || '%' escape '\'
				        CONNECT BY PARENT_ID = PRIOR ENTERPRISE_ID)
				   AND B.VALID_FLAG = '0'
				   AND B.FEE_FLAG = '0'
				   AND S.VALID_FLAG = '0'
				   AND T.VALID_FLAG = '0'
				   AND T.DEVICE_TYPE = '0'
				   AND S.DEVICE_TYPE = '0'
				   AND B.ORGANIZATION_ID = E.ENTERPRISE_ID(+)
				   AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
				   AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
				 ORDER BY iconSkin DESC,NLSSORT(NAME,'NLS_SORT=SCHINESE_PINYIN_M') ASC)
	</select>
	<!-- 车辆监控-组织树 end -->
	
	<!-- 车辆监控-线路树 begin -->
	<resultMap class="TreeNodeInfo" id="treeRouteNodes">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
	<select id="getRouteTreeNodes" parameterClass="String" resultMap="treeRouteNodes">
		SELECT *
		  FROM (SELECT DISTINCT ENT.ENTERPRISE_ID as ID,
		                        ENT.SHORT_NAME as NAME,
		                        null as PID,
		                        'true' as open,
		                        'pIcon' as iconSkin,
		                        '' as dvrState
		          FROM CLW_JC_ENTERPRISE_T ENT
		         WHERE ENTERPRISE_ID = #value#)
		UNION ALL
		SELECT *
		  FROM (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID,
		               ROUTE.ROUTE_NAME NAME,
		               #value# as PID,
		               'false' open,
		               'pIcon' as iconSkin,
		               '' as dvrState
		          FROM CLW_XC_ROUTE_T ROUTE
		         WHERE ROUTE_ORGANIZATION_ID in
		               (select enterprise_id
		                  from clw_jc_enterprise_vi
		                 where left_num &gt;=
		                       (select left_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #value#)
		                   and right_num &lt;=
		                       (select right_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #value#))
		           AND ROUTE.VALID_FLAG = '0'
		         ORDER BY NLSSORT(ROUTE_NAME, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
		UNION ALL
		SELECT *
		  FROM (SELECT  /*+ordered*/ DISTINCT T.VEHICLE_VIN ID,
		                        B.VEHICLE_LN NAME,
		                        TO_CHAR(VSS.ROUTE_ID) PID,
		                        'false' open,
		                        CASE
		                          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		                               30 * 60 THEN
		                           'offline'
		                          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		                               5 * 60 THEN
		                           'offline'
		                           WHEN T.TERMINAL_TIME is null THEN
		                  			  'offline'
		                          ELSE
		                           'online'
		                        END iconSkin,
		                        CASE
				                 <!-- WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
				                  'offdvr'
				                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
				                  'offdvr'
				                  WHEN 
				                      T.TERMINAL_TIME is null THEN
				                  'offdvr'
				                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' THEN
		                  			'offdvr' -->
		                  		  WHEN 
				                      T.TERMINAL_TIME is null THEN
				                  'offdvr'
				                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
				                  'offdvr'
				                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
				                  'offdvr'
						  		  WHEN 
				                      NVL(SUBSTRB(T.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
				                  'offdvr'
					                 ELSE
					                  'ondvr'
					               END dvrState
		          FROM CLW_JC_TERMINAL_T  T,
		               CLW_CL_BASE_INFO_T B,
		               CLW_CL_SIM_T       S,
		               CLW_XC_TRIP_T      VSS,
               		   CLW_XC_ROUTE_T XR
		         WHERE B.ORGANIZATION_ID IN (SELECT ENTERPRISE_ID
		                                       FROM CLW_JC_ENTERPRISE_VI
		                                      WHERE LEFT_NUM &gt;=
		                                            (SELECT LEFT_NUM
		                                               FROM CLW_JC_ENTERPRISE_VI
		                                              WHERE ENTERPRISE_ID =
		                                                    #value#)
		                                        AND RIGHT_NUM &lt;=
		                                            (SELECT RIGHT_NUM
		                                               FROM CLW_JC_ENTERPRISE_VI
		                                              WHERE ENTERPRISE_ID =
		                                                    #value#)
		                                     
		                                     )
		           AND B.VALID_FLAG = '0'
		           AND B.FEE_FLAG = '0'
		           AND S.VALID_FLAG = '0'
		           AND S.DEVICE_TYPE = '0'
		           AND T.VALID_FLAG = '0'
		           AND T.DEVICE_TYPE = '0'
		           AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
		           AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
		           AND T.VEHICLE_VIN = VSS.VEHICLE_VIN
		           AND VSS.ROUTE_ID = XR.ROUTE_ID
		           AND VSS.VALID_FLAG = '0'
                   AND XR.VALID_FLAG = '0'
		           AND T.VEHICLE_VIN in
		               (SELECT DISTINCT TS.VEHICLE_VIN
		                  FROM CLW_XC_TRIP_T TS
		                 WHERE TS.ROUTE_ID IN
		                       (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID
		                          FROM CLW_XC_ROUTE_T ROUTE
		                         WHERE ROUTE_ORGANIZATION_ID in
		                               (select enterprise_id
		                                  from clw_jc_enterprise_vi
		                                 where left_num &gt;=
		                                       (select left_num
		                                          from clw_jc_enterprise_vi
		                                         where enterprise_id =
		                                               #value#)
		                                   and right_num &lt;=
		                                       (select right_num
		                                          from clw_jc_enterprise_vi
		                                         where enterprise_id =
		                                               #value#))
		                           AND ROUTE.VALID_FLAG = '0'))
		         ORDER BY iconSkin DESC,
		                  NLSSORT(NAME, 'NLS_SORT=SCHINESE_PINYIN_M') ASC)
	</select>
	
	<resultMap class="TreeNodesAttri" id="routecarnumber_list">
       <result property="carnum" column="carnum"/>
       <result property="enterpriseId" column="enterprise_id"/>
    </resultMap>
    
	<select id="getRouteCarnumberByEnterprise" parameterClass="String" resultMap="routecarnumber_list">
		SELECT *
          FROM (SELECT parent_id as enterprise_id,
                  <![CDATA[     CONCAT(CONCAT(SUM(ONNUM), '/'), SUM(CARNUM)) as carnum
                  FROM (SELECT car_count_t.carnum,
                                    connect_by_root enterprise_id parent_id,
                               ONNUM                          
                               FROM (
                               SELECT T.enterprise_id,
                                   0 AS CARNUM,
                                   CASE
                                     WHEN T.ENTERPRISE_ID =#value# THEN
                                      NULL
                                     ELSE
                                      T.parent_id
                                   END AS parent_id,
                                   0 AS ONNUM
                              FROM clw_jc_enterprise_t T
                             WHERE T.ENTERPRISE_ID IN
                                   (select t.ENTERPRISE_ID
                                      from clw_jc_enterprise_t t
                                     where t.valid_flag = '0'
                                     START WITH t.ENTERPRISE_ID =#value#
                                    CONNECT BY PRIOR t.ENTERPRISE_ID = t.PARENT_ID)
                               AND ENTERPRISE_ID NOT IN
                                   (select distinct cbi.organization_id
                                      FROM CLW_JC_TERMINAL_T   JT,
                                           CLW_CL_BASE_INFO_T  CBI,
                                           CLW_CL_SIM_T        CS,
                                           CLW_JC_ENTERPRISE_T JE
                                     WHERE JT.VEHICLE_VIN = CBI.VEHICLE_VIN(+)
                                       AND JT.SIM_CARD_NUMBER = CS.SIM_CARD_NUMBER(+)
                                       AND CBI.ENTERPRISE_ID = JE.ENTERPRISE_ID(+)
                                       AND JT.TERMINAL_ID IS NOT NULL
                                       AND JT.VEHICLE_VIN IS NOT NULL
                                       AND JT.SIM_CARD_NUMBER IS NOT NULL
                                       AND JT.VALID_FLAG = '0'
                                       AND CBI.VALID_FLAG = '0'
                                       AND CS.VALID_FLAG = '0'
                                       AND JT.DEVICE_TYPE = '0'
                                       AND CBI.DEVICE_TYPE = '0'
                                       AND CS.DEVICE_TYPE = '0'
                                       AND CBI.ORGANIZATION_ID IS NOT NULL
                                       AND CBI.ENTERPRISE_ID = #value#)
                                              and t.valid_flag = '0'
                               
                                UNION ALL
                                
                                SELECT CBI.ORGANIZATION_ID AS enterprise_id,
                                       COUNT(1) AS CARNUM,
                                       (select CASE
                                                 WHEN ENTERPRISE_ID =
                                                      #value# THEN
                                                  NULL
                                                 ELSE
                                                  parent_id
                                               END AS parent_id
                                          from clw_jc_enterprise_t
                                         where enterprise_id = CBI.ORGANIZATION_ID) as parent_id,
                                       SUM(CASE
                                             WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '0' AND
                                                  (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 >=
                                                  30 * 60 THEN
                                              '0'
                                             WHEN NVL(SUBSTRB(JT.STAT_INFO, 32, 1), '1') = '1' AND
                                                  (SYSDATE - JT.TERMINAL_TIME) * 24 * 60 * 60 <=
                                                  5 * 60 THEN
                                              '0'
                                              WHEN JT.TERMINAL_TIME is null THEN
                                                    '0'
                                             ELSE
                                              '1'
                                           END) AS ONNUM
                                  FROM CLW_JC_TERMINAL_T   JT,
                                       CLW_CL_BASE_INFO_T  CBI,
                                       CLW_CL_SIM_T        CS,
                                       CLW_JC_ENTERPRISE_T JE
                                 WHERE JT.VEHICLE_VIN = CBI.VEHICLE_VIN(+)
                                   AND JT.SIM_CARD_NUMBER = CS.SIM_CARD_NUMBER(+)
                                   AND CBI.ENTERPRISE_ID = JE.ENTERPRISE_ID(+)
                                   AND JT.TERMINAL_ID IS NOT NULL
                                   AND JT.VEHICLE_VIN IS NOT NULL
                                   AND JT.SIM_CARD_NUMBER IS NOT NULL
                                   AND JT.VALID_FLAG = '0'
                                   AND CBI.VALID_FLAG = '0'
                                   AND CS.VALID_FLAG = '0'
                                   AND JT.DEVICE_TYPE = '0'
                                   AND CBI.DEVICE_TYPE = '0'
                                   AND CS.DEVICE_TYPE = '0'
                                   AND CBI.ORGANIZATION_ID IS NOT NULL
                                   AND EXISTS
									 (SELECT 1
									          FROM CLW_JC_ENTERPRISE_T
									         WHERE VALID_FLAG = '0'
									           AND LEFT_NUM >=
									               (SELECT LEFT_NUM
									                  FROM CLW_JC_ENTERPRISE_T
									                 WHERE ENTERPRISE_ID = #enterpriseId#)
									           AND RIGHT_NUM <=
									               (SELECT RIGHT_NUM
									                  FROM CLW_JC_ENTERPRISE_T
									                 WHERE ENTERPRISE_ID = #enterpriseId#)
									           AND CBI.ORGANIZATION_ID = ENTERPRISE_ID)
						                                 GROUP BY CBI.ORGANIZATION_ID
						                                 ) car_count_t
                         
                        CONNECT BY PRIOR car_count_t.enterprise_id = car_count_t.parent_id)
                 GROUP BY parent_id)
                 
        union ALL
        
        SELECT TO_CHAR(enterprise_id) AS enterprise_id, CARNUM
          FROM (SELECT OO.ID as enterprise_id,
                       CONCAT(CONCAT(SUM(ONNUM), '/'), SUM(CARNUM)) as carnum
                  FROM (SELECT COUNT(RV.ROUTE_ID) CARNUM,
                               RV.ROUTE_ID ID,
                               SUM(RV.ONOFF) ONNUM
                          FROM (SELECT DISTINCT XC.ROUTE_ID,
                                                XC.VEHICLE_VIN,
                                                CASE
                                                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1),
                                                           '1') = '0' AND
                                                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >=
                                                       30 * 60 THEN
                                                   '0'
                                                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1),
                                                           '1') = '1' AND
                                                       (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >=
                                                       5 * 60 THEN
                                                   '0'
                                                   WHEN T.TERMINAL_TIME is null THEN
                                                        '0'
                                                  ELSE
                                                   '1'
                                                END AS ONOFF
                                
                                  FROM CLW_XC_TRIP_T XC, CLW_JC_TERMINAL_T T,CLW_CL_BASE_INFO_T B
                                 WHERE XC.VEHICLE_VIN = T.VEHICLE_VIN
                                   AND XC.VEHICLE_VIN = B.VEHICLE_VIN 
                                   AND XC.ROUTE_ID in
                                       (SELECT DISTINCT R.ROUTE_ID
                                          FROM CLW_XC_ROUTE_T R
                                         WHERE ROUTE_ORGANIZATION_ID in
                                               (select enterprise_id
                                                  from CLW_JC_ENTERPRISE_T
                                                 where left_num >=
                                                       (select left_num
                                                          from CLW_JC_ENTERPRISE_T
                                                         where enterprise_id =
                                                               #value#)
                                                   and right_num <=
                                                       (select right_num
                                                          from CLW_JC_ENTERPRISE_T
                                                         where enterprise_id =
                                                               #value#))
                                           AND R.VALID_FLAG = '0'
                                           )
                                           AND XC.VALID_FLAG = '0'
                                           AND B.ORGANIZATION_ID in (select enterprise_id
                                                  from CLW_JC_ENTERPRISE_T
                                                 where left_num >=
                                                       (select left_num
                                                          from CLW_JC_ENTERPRISE_T
                                                         where enterprise_id =
                                                               #value#)
                                                   and right_num <=
                                                       (select right_num
                                                          from CLW_JC_ENTERPRISE_T
                                                         where enterprise_id =
                                                               #value#))
                                           ) RV
                         GROUP BY RV.ROUTE_ID                
                        UNION            
                        SELECT DISTINCT 0 CANUM, R.ROUTE_ID ID, 0 ONNUM
                          FROM CLW_XC_ROUTE_T R
                         WHERE ROUTE_ORGANIZATION_ID in
                               (select enterprise_id
                                  from CLW_JC_ENTERPRISE_T
                                 where left_num >=
                                       (select left_num
                                          from CLW_JC_ENTERPRISE_T
                                         where enterprise_id =
                                               #value#)
                                   and right_num <=
                                       (select right_num
                                          from CLW_JC_ENTERPRISE_T
                                         where enterprise_id =
                                               #value#))
                                               ]]>
                           AND R.VALID_FLAG = '0') OO
                 GROUP BY OO.ID)
	</select>
	
	<resultMap class="TreeNodeInfo" id="searchRouteTreeNodes">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
    <!-- 车辆监控线路树按车牌查询 -->
	<select id="searchRouteTreeNodes" parameterClass="Map" resultMap="searchRouteTreeNodes">
		SELECT *
		  FROM (SELECT DISTINCT ENT.ENTERPRISE_ID as ID,
		                        ENT.SHORT_NAME as NAME,
		                        null as PID,
		                        'true' as open,
		                        'pIcon' as iconSkin,
		                        '' as dvrState
		          FROM CLW_JC_ENTERPRISE_T ENT
		         WHERE ENTERPRISE_ID = #enterpriseId#)
		UNION ALL
		SELECT *
		  FROM (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID,
		               ROUTE.ROUTE_NAME NAME,
		               #enterpriseId# as PID,
		               'true' open,
		               'pIcon' as iconSkin,
		               '' as dvrState
		          FROM CLW_XC_ROUTE_T ROUTE
		         WHERE ROUTE_ORGANIZATION_ID in
		               (select enterprise_id
		                  from clw_jc_enterprise_vi
		                 where left_num &gt;=
		                       (select left_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #enterpriseId#)
		                   and right_num &lt;=
		                       (select right_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #enterpriseId#))
		           AND ROUTE.VALID_FLAG = '0'
		           AND ROUTE.ROUTE_ID IN
		               (SELECT DISTINCT TO_CHAR(VSS.ROUTE_ID) PID
		                  FROM CLW_JC_TERMINAL_T  T,
		                       CLW_CL_BASE_INFO_T B,
		                       CLW_CL_SIM_T       S,
		                       CLW_XC_TRIP_T      VSS,
		                       CLW_XC_ROUTE_T     XR
		                 WHERE B.ORGANIZATION_ID IN
		                       (SELECT ENTERPRISE_ID
		                          FROM CLW_JC_ENTERPRISE_VI
		                         WHERE LEFT_NUM &gt;=
		                               (SELECT LEFT_NUM
		                                  FROM CLW_JC_ENTERPRISE_VI
		                                 WHERE ENTERPRISE_ID =
		                                       #enterpriseId#)
		                           AND RIGHT_NUM &lt;=
		                               (SELECT RIGHT_NUM
		                                  FROM CLW_JC_ENTERPRISE_VI
		                                 WHERE ENTERPRISE_ID =
		                                       #enterpriseId#))
		                   AND B.VALID_FLAG = '0'
		                   AND B.FEE_FLAG = '0'
		                   AND S.VALID_FLAG = '0'
		                   AND S.DEVICE_TYPE = '0'
		                   AND T.VALID_FLAG = '0'
		                   AND T.DEVICE_TYPE = '0'
		                   AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
		                   AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
		                   AND T.VEHICLE_VIN = VSS.VEHICLE_VIN
		                   AND VSS.ROUTE_ID = XR.ROUTE_ID
		                   AND VSS.VALID_FLAG = '0'
		                   AND XR.VALID_FLAG = '0'
		                   AND T.VEHICLE_VIN in
		                       (SELECT DISTINCT TS.VEHICLE_VIN
		                          FROM CLW_XC_TRIP_T TS
		                         WHERE TS.ROUTE_ID IN
		                               (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID
		                                  FROM CLW_XC_ROUTE_T ROUTE
		                                 WHERE ROUTE_ORGANIZATION_ID in
		                                       (select enterprise_id
		                                          from clw_jc_enterprise_vi
		                                         where left_num &gt;=
		                                               (select left_num
		                                                  from clw_jc_enterprise_vi
		                                                 where enterprise_id =
		                                                       #enterpriseId#)
		                                           and right_num &lt;=
		                                               (select right_num
		                                                  from clw_jc_enterprise_vi
		                                                 where enterprise_id =
		                                                       #enterpriseId#))
		                                   AND ROUTE.VALID_FLAG = '0'))
		                   AND B.VEHICLE_LN LIKE '%' || #name# || '%' escape '\')
		         ORDER BY NLSSORT(ROUTE_NAME, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
		UNION ALL
		SELECT *
		  FROM (SELECT DISTINCT T.VEHICLE_VIN ID,
		                        B.VEHICLE_LN NAME,
		                        TO_CHAR(VSS.ROUTE_ID) PID,
		                        'false' open,
		                        CASE
		                          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		                               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		                               30 * 60 THEN
		                           'offline'
		                          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		                               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		                               5 * 60 THEN
		                           'offline'
		                           WHEN T.TERMINAL_TIME is null THEN
		                  			  'offline'
		                          ELSE
		                           'online'
		                        END iconSkin,
		                        CASE
				                 <!-- WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
				                  'offdvr'
				                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
				                  'offdvr'
				                  WHEN 
				                      T.TERMINAL_TIME is null THEN
				                  'offdvr'
				                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' THEN
		                  		  'offdvr'-->
						  		  WHEN 
				                      T.TERMINAL_TIME is null THEN
				                  'offdvr'
				                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
				                  'offdvr'
				                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
				                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
				                  'offdvr'
						  		  WHEN 
				                      NVL(SUBSTRB(T.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
				                  	 'offdvr'
					              ELSE
					                 'ondvr'
					               END dvrState
		          FROM CLW_JC_TERMINAL_T  T,
		               CLW_CL_BASE_INFO_T B,
		               CLW_CL_SIM_T       S,
		               CLW_XC_TRIP_T      VSS,
		               CLW_XC_ROUTE_T     XR
		         WHERE B.ORGANIZATION_ID IN
		               (SELECT ENTERPRISE_ID
		                  FROM CLW_JC_ENTERPRISE_VI
		                 WHERE LEFT_NUM &gt;=
		                       (SELECT LEFT_NUM
		                          FROM CLW_JC_ENTERPRISE_VI
		                         WHERE ENTERPRISE_ID =
		                               #enterpriseId#)
		                   AND RIGHT_NUM &lt;=
		                       (SELECT RIGHT_NUM
		                          FROM CLW_JC_ENTERPRISE_VI
		                         WHERE ENTERPRISE_ID =
		                               #enterpriseId#))
		           AND B.VALID_FLAG = '0'
		           AND B.FEE_FLAG = '0'
		           AND S.VALID_FLAG = '0'
		           AND S.DEVICE_TYPE = '0'
		           AND T.VALID_FLAG = '0'
		           AND T.DEVICE_TYPE = '0'
		           AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
		           AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
		           AND T.VEHICLE_VIN = VSS.VEHICLE_VIN
		           AND VSS.ROUTE_ID = XR.ROUTE_ID
		           AND VSS.VALID_FLAG = '0'
		           AND XR.VALID_FLAG = '0'
		           AND T.VEHICLE_VIN in
		               (SELECT DISTINCT TS.VEHICLE_VIN
		                  FROM CLW_XC_TRIP_T TS
		                 WHERE TS.ROUTE_ID IN
		                       (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID
		                          FROM CLW_XC_ROUTE_T ROUTE
		                         WHERE ROUTE_ORGANIZATION_ID in
		                               (select enterprise_id
		                                  from clw_jc_enterprise_vi
		                                 where left_num &gt;=
		                                       (select left_num
		                                          from clw_jc_enterprise_vi
		                                         where enterprise_id =
		                                               #enterpriseId#)
		                                   and right_num &lt;=
		                                       (select right_num
		                                          from clw_jc_enterprise_vi
		                                         where enterprise_id =
		                                               #enterpriseId#))
		                           AND ROUTE.VALID_FLAG = '0'))
		           AND B.VEHICLE_LN LIKE '%' || #name# || '%' escape '\'
		         ORDER BY iconSkin DESC,
		                  NLSSORT(NAME, 'NLS_SORT=SCHINESE_PINYIN_M') ASC)
	</select>
	
	<resultMap class="TreeNodeInfo" id="searchTreeNodesByRouteName">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
       <result property="dvrState" column="dvrState"/>
    </resultMap>
    <!-- 车辆监控线路树按线路名称查询 -->
	<select id="searchTreeNodesByRouteName" parameterClass="Map" resultMap="searchTreeNodesByRouteName">
		SELECT *
		  FROM (SELECT DISTINCT ENT.ENTERPRISE_ID as ID,
		                        ENT.SHORT_NAME as NAME,
		                        null as PID,
		                        'true' as open,
		                        'pIcon' as iconSkin,
		                        '' as dvrState
		          FROM CLW_JC_ENTERPRISE_T ENT
		         WHERE ENTERPRISE_ID = #enterpriseId#)
		UNION ALL
		SELECT *
		FROM (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID,
		   ROUTE.ROUTE_NAME NAME,
		   #enterpriseId# as PID,
		   'true' open,
		   'pIcon' as iconSkin,
		   '' as dvrState
		FROM CLW_XC_ROUTE_T ROUTE
		WHERE ROUTE_ORGANIZATION_ID in
		   (select enterprise_id
		      from clw_jc_enterprise_vi
		     where left_num &gt;=
		           (select left_num
		              from clw_jc_enterprise_vi
		             where enterprise_id =
		                   #enterpriseId#)
		       and right_num &lt;=
		           (select right_num
		              from clw_jc_enterprise_vi
		             where enterprise_id =
		                   #enterpriseId#))
		AND ROUTE.VALID_FLAG = '0'
		AND ROUTE.ROUTE_NAME LIKE '%' || #name# || '%' escape '\'
		ORDER BY NLSSORT(ROUTE_NAME, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
		UNION ALL
		SELECT *
		FROM (SELECT DISTINCT T.VEHICLE_VIN ID,
		        B.VEHICLE_LN NAME,
		        TO_CHAR(VSS.ROUTE_ID) PID,
		        'false' open,
		        CASE
		          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
		               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		               30 * 60 THEN
		           'offline'
		          WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
		               (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 &gt;=
		               5 * 60 THEN
		           'offline'
		           WHEN T.TERMINAL_TIME is null THEN
		                  			  'offline'
		          ELSE
		           'online'
		        END iconSkin,
		        CASE
                 <!-- WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
                  'offdvr'
                 WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
                  'offdvr'
                  WHEN 
                      T.TERMINAL_TIME is null THEN
                  'offdvr'
                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' THEN
		                  'offdvr' -->
		  		  WHEN 
                      T.TERMINAL_TIME is null THEN
                  'offdvr'
                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '0' AND
                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 30 * 60 THEN
                  'offdvr'
                  WHEN NVL(SUBSTRB(T.STAT_INFO, 32, 1), '1') = '1' AND
                      (SYSDATE - T.TERMINAL_TIME) * 24 * 60 * 60 >= 5 * 60 THEN
                  'offdvr'
		  		  WHEN 
                      NVL(SUBSTRB(T.VEH_EXT_INFO, 1, 1), '1') = '0' THEN
                  'offdvr'
	                 ELSE
	              'ondvr'
	               END dvrState
		  FROM CLW_JC_TERMINAL_T  T,
		       CLW_CL_BASE_INFO_T B,
		       CLW_CL_SIM_T       S,
		       CLW_XC_TRIP_T      VSS,
		       CLW_XC_ROUTE_T XR
		 WHERE B.ORGANIZATION_ID IN (SELECT ENTERPRISE_ID
		                       FROM CLW_JC_ENTERPRISE_VI
		                      WHERE LEFT_NUM &gt;=
		                        (SELECT LEFT_NUM
		                           FROM CLW_JC_ENTERPRISE_VI
		                          WHERE ENTERPRISE_ID =
		                            #enterpriseId#)
		                    AND RIGHT_NUM &lt;=
		                        (SELECT RIGHT_NUM
		                           FROM CLW_JC_ENTERPRISE_VI
		                          WHERE ENTERPRISE_ID =
		                            #enterpriseId#)  
		                     )
		       AND B.VALID_FLAG = '0'
		       AND B.FEE_FLAG = '0'
		       AND S.VALID_FLAG = '0'
		       AND S.DEVICE_TYPE = '0'
		       AND T.VALID_FLAG = '0'
		       AND T.DEVICE_TYPE = '0'
		       AND T.VEHICLE_VIN = B.VEHICLE_VIN(+)
		       AND T.SIM_CARD_NUMBER = S.SIM_CARD_NUMBER(+)
		       AND T.VEHICLE_VIN = VSS.VEHICLE_VIN
		       AND VSS.ROUTE_ID = XR.ROUTE_ID
		       AND VSS.VALID_FLAG = '0'
		       AND XR.VALID_FLAG = '0'
		       AND VSS.ROUTE_ID in
		           (SELECT DISTINCT TS.ROUTE_ID
		          FROM CLW_XC_TRIP_T TS
		         WHERE TS.ROUTE_ID IN
		               (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID
		            FROM CLW_XC_ROUTE_T ROUTE
		            WHERE ROUTE_ORGANIZATION_ID in
		               (select enterprise_id
		                  from clw_jc_enterprise_vi
		                 where left_num &gt;=
		                   (select left_num
		                      from clw_jc_enterprise_vi
		                     where enterprise_id =
		                       #enterpriseId#)
		                   and right_num &lt;=
		                   (select right_num
		                      from clw_jc_enterprise_vi
		                     where enterprise_id =
		                       #enterpriseId#))
		            AND ROUTE.ROUTE_NAME LIKE '%' || #name# || '%' escape '\'
		            AND ROUTE.VALID_FLAG = '0'))
		     ORDER BY iconSkin DESC,
		          NLSSORT(NAME, 'NLS_SORT=SCHINESE_PINYIN_M') ASC)
	</select>
	<!-- 车辆监控-线路树 end -->
	
	<!-- 无复选组织线路树 begin -->
	<resultMap class="TreeNodeInfo" id="organizationRoute_tree">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
    </resultMap>
	<select id="getOrganizationRouteData" parameterClass="String" resultMap="organizationRoute_tree">
		SELECT *
		  FROM (SELECT DISTINCT ENT.ENTERPRISE_ID as ID,
		                        ENT.SHORT_NAME as NAME,
		                        ENT.PARENT_ID as PID,
		                        case
		                          when ENTERPRISE_ID =
		                               #value# then
		                           'true'
		                          else
		                           'false'
		                        end open,
		                        'pIcon' as iconSkin
		          FROM CLW_JC_ENTERPRISE_T ENT
		         START WITH ENTERPRISE_ID IN (SELECT DISTINCT R.ROUTE_ORGANIZATION_ID PID
		                                        FROM CLW_XC_ROUTE_T R
		                                       WHERE ROUTE_ORGANIZATION_ID in
		                                             (select enterprise_id
		                                                from clw_jc_enterprise_vi
		                                               where left_num &gt;=
		                                                     (select left_num
		                                                        from clw_jc_enterprise_vi
		                                                       where enterprise_id =
		                                                             #value#)
		                                                 and right_num &lt;=
		                                                     (select right_num
		                                                        from clw_jc_enterprise_vi
		                                                       where enterprise_id =
		                                                             #value#))
		                                         AND R.VALID_FLAG = '0'
		                                      
		                                      )
		        CONNECT BY PRIOR PARENT_ID = ENTERPRISE_ID
		               AND VALID_FLAG = '0'
		               AND LEFT_NUM &gt;=
		                   (SELECT LEFT_NUM
		                      FROM CLW_JC_ENTERPRISE_VI
		                     WHERE ENTERPRISE_ID =
		                           #value#)
		               AND RIGHT_NUM &lt;=
		                   (SELECT RIGHT_NUM
		                      FROM CLW_JC_ENTERPRISE_VI
		                     WHERE ENTERPRISE_ID =
		                           #value#)
		         ORDER BY NLSSORT(name, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
		UNION ALL
		SELECT *
		  FROM (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID,
		               ROUTE.ROUTE_NAME NAME,
		               ROUTE.ROUTE_ORGANIZATION_ID PID,
		               'false' open,
		               'pLine' as iconSkin
		          FROM CLW_XC_ROUTE_T ROUTE
		         WHERE ROUTE_ORGANIZATION_ID in
		               (select enterprise_id
		                  from clw_jc_enterprise_vi
		                 where left_num &gt;=
		                       (select left_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #value#)
		                   and right_num &lt;=
		                       (select right_num
		                          from clw_jc_enterprise_vi
		                         where enterprise_id =
		                               #value#))
		           AND ROUTE.VALID_FLAG = '0'
		         ORDER BY NLSSORT(name, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
	</select>
	
	<resultMap class="TreeNodesAttri" id="routenumber_list">
       <result property="carnum" column="routenum"/>
       <result property="enterpriseId" column="enterprise_id"/>
    </resultMap>
	<select id="getRouteNumberByEnterprise" parameterClass="String" resultMap="routenumber_list">
		 SELECT parent_id as enterprise_id, SUM(ROUTE_NUM) as routenum
		   FROM (SELECT car_count_t.ROUTE_NUM,
		                connect_by_root enterprise_id parent_id
		           FROM (SELECT T.enterprise_id AS enterprise_id,
		                        0 AS ROUTE_NUM,
		                        CASE
		                          WHEN T.ENTERPRISE_ID =
		                               #value# THEN
		                           NULL
		                          ELSE
		                           T.parent_id
		                        END AS parent_id
		                   FROM CLW_JC_ENTERPRISE_VI T
		                  WHERE LEFT_NUM &gt;=
		                        (SELECT LEFT_NUM
		                           FROM CLW_JC_ENTERPRISE_VI
		                          WHERE ENTERPRISE_ID =
		                                #value#)
		                    AND RIGHT_NUM &lt;=
		                        (SELECT RIGHT_NUM
		                           FROM CLW_JC_ENTERPRISE_VI
		                          WHERE ENTERPRISE_ID =
		                                #value#)
		                    AND ENTERPRISE_ID NOT IN
		                        (SELECT ROUTE_ORGANIZATION_ID
		                           FROM CLW_XC_ROUTE_T ROUTE
		                          WHERE ROUTE_ORGANIZATION_ID in
		                                (select enterprise_id
		                                   from clw_jc_enterprise_vi
		                                  where left_num &gt;=
		                                        (select left_num
		                                           from clw_jc_enterprise_vi
		                                          where enterprise_id =
		                                                #value#)
		                                    and right_num &lt;=
		                                        (select right_num
		                                           from clw_jc_enterprise_vi
		                                          where enterprise_id =
		                                                #value#))
		                            AND ROUTE.VALID_FLAG = '0'
		                          GROUP BY ROUTE.ROUTE_ORGANIZATION_ID)
		                 UNION ALL
		                 SELECT ROUTE_ORGANIZATION_ID AS enterprise_id,
		                        COUNT(1) AS ROUTE_NUM,
		                        (select CASE
		                                  WHEN ROUTE_ORGANIZATION_ID =
		                                       #value# THEN
		                                   NULL
		                                  ELSE
		                                   parent_id
		                                END AS parent_id
		                           from clw_jc_enterprise_t
		                          where enterprise_id = ROUTE_ORGANIZATION_ID) as parent_id
		                   FROM CLW_XC_ROUTE_T ROUTE
		                  WHERE ROUTE_ORGANIZATION_ID in
		                        (select enterprise_id
		                           from clw_jc_enterprise_vi
		                          where left_num &gt;=
		                                (select left_num
		                                   from clw_jc_enterprise_vi
		                                  where enterprise_id =
		                                        #value#)
		                            and right_num &lt;=
		                                (select right_num
		                                   from clw_jc_enterprise_vi
		                                  where enterprise_id =
		                                        #value#))
		                    AND ROUTE.VALID_FLAG = '0'
		                  GROUP BY ROUTE.ROUTE_ORGANIZATION_ID) car_count_t
		          START WITH car_count_t.enterprise_id IN
		                     (SELECT ENTERPRISE_ID
		                        FROM CLW_JC_ENTERPRISE_VI
		                       WHERE LEFT_NUM &gt;=
		                             (SELECT LEFT_NUM
		                                FROM CLW_JC_ENTERPRISE_VI
		                               WHERE ENTERPRISE_ID =
		                                     #value#)
		                         AND RIGHT_NUM &lt;=
		                             (SELECT RIGHT_NUM
		                                FROM CLW_JC_ENTERPRISE_VI
		                               WHERE ENTERPRISE_ID =
		                                     #value#))
		         CONNECT BY PRIOR car_count_t.enterprise_id = car_count_t.parent_id
		         )
		  GROUP BY parent_id
	</select>
	
	<resultMap class="TreeNodeInfo" id="searchRouteTreeByRouteName">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
    </resultMap>
	<select id="searchRouteTreeByRouteName" parameterClass="Map" resultMap="searchRouteTreeByRouteName">
		SELECT *
	      FROM (SELECT DISTINCT ENT.ENTERPRISE_ID as ID,
	                            ENT.SHORT_NAME as NAME,
	                            ENT.PARENT_ID as PID,
	                            'true' as open,
	                            'pIcon' as iconSkin
	              FROM CLW_JC_ENTERPRISE_T ENT
	             START WITH ENTERPRISE_ID IN (SELECT DISTINCT R.ROUTE_ORGANIZATION_ID PID
	                                            FROM CLW_XC_ROUTE_T R
	                                           WHERE ROUTE_ORGANIZATION_ID in
	                                                 (select enterprise_id
	                                                    from clw_jc_enterprise_vi
	                                                   where left_num &gt;=
	                                                         (select left_num
	                                                            from clw_jc_enterprise_vi
	                                                           where enterprise_id =
	                                                                 #enterpriseId#)
	                                                     and right_num &lt;=
	                                                         (select right_num
	                                                            from clw_jc_enterprise_vi
	                                                           where enterprise_id =
	                                                                 #enterpriseId#))
	                                             AND R.VALID_FLAG = '0'
	                                             AND R.ROUTE_NAME like '%' || #name# ||'%' escape '\'
	                                          )
	            CONNECT BY PRIOR PARENT_ID = ENTERPRISE_ID
	                   AND VALID_FLAG = '0'
	                   AND LEFT_NUM &gt;=
	                       (SELECT LEFT_NUM
	                          FROM CLW_JC_ENTERPRISE_VI
	                         WHERE ENTERPRISE_ID =
	                               #enterpriseId#)
	                   AND RIGHT_NUM &lt;=
	                       (SELECT RIGHT_NUM
	                          FROM CLW_JC_ENTERPRISE_VI
	                         WHERE ENTERPRISE_ID =
	                               #enterpriseId#)
	             ORDER BY NLSSORT(name, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
	             UNION ALL
	     SELECT *
			  FROM (SELECT TO_CHAR(ROUTE.ROUTE_ID) ID,
			               ROUTE.ROUTE_NAME NAME,
			               ROUTE.ROUTE_ORGANIZATION_ID PID,
			               'false' open,
			               'pLine' as iconSkin
			          FROM CLW_XC_ROUTE_T ROUTE
			         WHERE ROUTE_ORGANIZATION_ID in
			               (select enterprise_id
			                  from clw_jc_enterprise_vi
			                 where left_num &gt;=
			                       (select left_num
			                          from clw_jc_enterprise_vi
			                         where enterprise_id =
			                               #enterpriseId#)
			                   and right_num &lt;=
			                       (select right_num
			                          from clw_jc_enterprise_vi
			                         where enterprise_id =
			                               #enterpriseId#))
			           AND ROUTE.VALID_FLAG = '0'
	               AND ROUTE.ROUTE_NAME like '%' || #name# ||'%' escape '\'
			         ORDER BY NLSSORT(name, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
	</select>
	<!-- 无复选组织线路树 begin -->
	
	
	<!-- 只显示组织数据树 begin -->
	<resultMap class="TreeNodeInfo" id="organization_tree">
       <result property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="pId" column="pId"/>
       <result property="open" column="open"/>
       <result property="iconSkin" column="iconSkin"/>
    </resultMap>
	<select id="getOrganizationTreeData" parameterClass="String" resultMap="organization_tree">
		SELECT ENTERPRISE_ID as id,
		       SHORT_NAME as name,
		       PARENT_ID as pId,
		       'true' as open,
		       'pIcon' as iconSkin
	      FROM CLW_JC_ENTERPRISE_T
	     START WITH ENTERPRISE_ID = #value#
	   CONNECT BY PRIOR ENTERPRISE_ID = PARENT_ID
	       AND VALID_FLAG='0'
	    ORDER BY NAME DESC
	</select>
	<!-- 只显示组织数据树end -->
	
	<!-- 驾驶员组织数据树 -->
	<select id="getTreeNodesWithDriver" parameterClass="Map" resultMap="treeNodes">
		SELECT *
		  FROM (SELECT ENTERPRISE_ID as id, SHORT_NAME as name,PARENT_ID as pId,
		        CASE WHEN ENTERPRISE_ID =  #enterpriseId# THEN 'true' ELSE 'false' END open,
		        'pIcon' as iconSkin,'' dvrState
		          FROM CLW_JC_ENTERPRISE_T
		         WHERE  ENTERPRISE_ID =  #enterpriseId# AND VALID_FLAG = '0'
		         ORDER BY NLSSORT(name, 'NLS_SORT=SCHINESE_PINYIN_M') DESC)
		UNION ALL
		SELECT TO_CHAR(DT.DRIVER_ID) id,DT.DRIVER_NAME name,#enterpriseId# pId, 'false' AS open,'pIcon' as iconSkin,'' dvrState 
		FROM CLW_YW_DRIVER_T DT WHERE ORGANIZATION_ID IN 
		(SELECT ENTERPRISE_ID FROM CLW_JC_ENTERPRISE_VI
          WHERE LEFT_NUM &gt;=
                (SELECT LEFT_NUM
                   FROM CLW_JC_ENTERPRISE_VI
                  WHERE ENTERPRISE_ID =
                        #enterpriseId#)
            AND RIGHT_NUM &lt;=
                (SELECT RIGHT_NUM
                   FROM CLW_JC_ENTERPRISE_VI
                  WHERE ENTERPRISE_ID =
                        #enterpriseId#))
		<isNotEmpty prepend="AND" property="name">
			DT.DRIVER_NAME like '%' || #name# ||'%' escape '\'
		</isNotEmpty>

	</select>
</sqlMap>